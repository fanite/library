name: Build QuickJS Shared Libraries

on:
  push:
    tags:
      - 'libqjs-*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag'
        required: true
        default: 'v0.12.1'

env:
  QJS_REPO: https://github.com/quickjs-ng/quickjs.git
  BUILD_TYPE: Release

jobs:
  build:
    name: ${{ matrix.platform }}-${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Android
          - platform: android
            arch: arm
            runner: ubuntu-latest
            target: arm-linux-androideabi
            ndk_abi: armeabi-v7a
          - platform: android
            arch: arm64
            runner: ubuntu-latest
            target: aarch64-linux-android
            ndk_abi: arm64-v8a
          - platform: android
            arch: ia32
            runner: ubuntu-latest
            target: i686-linux-android
            ndk_abi: x86
          - platform: android
            arch: riscv32
            runner: ubuntu-latest
            target: riscv32-linux-android
            ndk_abi: riscv32
          - platform: android
            arch: riscv64
            runner: ubuntu-latest
            target: riscv64-linux-android
            ndk_abi: riscv64
          - platform: android
            arch: x64
            runner: ubuntu-latest
            target: x86_64-linux-android
            ndk_abi: x86_64
          
          # Fuchsia
          - platform: fuchsia
            arch: arm64
            runner: ubuntu-latest
            target: aarch64-fuchsia
          - platform: fuchsia
            arch: x64
            runner: ubuntu-latest
            target: x86_64-fuchsia
          
          # iOS
          - platform: ios
            arch: arm64
            runner: macos-latest
            target: arm64-apple-ios
          
          # Linux
          - platform: linux
            arch: arm
            runner: ubuntu-latest
            target: arm-linux-gnueabihf
          - platform: linux
            arch: arm64
            runner: ubuntu-latest
            target: aarch64-linux-gnu
          - platform: linux
            arch: ia32
            runner: ubuntu-latest
            target: i686-linux-gnu
          - platform: linux
            arch: riscv32
            runner: ubuntu-latest
            target: riscv32-linux-gnu
          - platform: linux
            arch: riscv64
            runner: ubuntu-latest
            target: riscv64-linux-gnu
          - platform: linux
            arch: x64
            runner: ubuntu-latest
            target: x86_64-linux-gnu
          
          # macOS
          - platform: macos
            arch: arm64
            runner: macos-latest
            target: arm64-apple-darwin
          - platform: macos
            arch: x64
            runner: macos-latest
            target: x86_64-apple-darwin
          
          # Windows
          - platform: windows
            arch: x64
            runner: windows-latest
            target: x64
            generator: "Visual Studio 17 2022"
            arch_flag: x64
          - platform: windows
            arch: ia32
            runner: windows-latest
            target: x86
            generator: "Visual Studio 17 2022"
            arch_flag: Win32
          - platform: windows
            arch: arm64
            runner: windows-latest
            target: arm64
            generator: "Visual Studio 17 2022"
            arch_flag: ARM64

    steps:
    - name: Checkout QuickJS
      uses: actions/checkout@v4
      with:
        repository: quickjs-ng/quickjs.git
        ref: ${{ inputs.version }}
        path: quickjs

    - name: Set version
      id: version
      run: |
        if [ "${{ github.event_name }}" = "push" ]; then
          VERSION=${GITHUB_REF_NAME#libqjs-}
        else
          VERSION=${{ github.event.inputs.version }}
          VERSION=${VERSION#libqjs-}
        fi
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "version=$VERSION" >> $GITHUB_OUTPUT
      shell: bash

    - name: Setup CMake
      uses: jwlawson/actions-setup-cmake@v2
      with:
        cmake-version: '3.27.x'

    - name: Install Android NDK
      if: startsWith(matrix.platform, 'android')
      run: |
        NDK_VERSION=r26d
        NDK_ZIP=android-ndk-${NDK_VERSION}-linux.zip
        NDK_URL=https://dl.google.com/android/repository/${NDK_ZIP}
        
        echo "Downloading Android NDK ${NDK_VERSION}..."
        wget -q ${NDK_URL}
        
        echo "Extracting Android NDK..."
        unzip -q ${NDK_ZIP} -d ${{ runner.temp }}
        
        ANDROID_NDK_HOME="${{ runner.temp }}/android-ndk-${NDK_VERSION}"
        echo "ANDROID_NDK_HOME=${ANDROID_NDK_HOME}" >> $GITHUB_ENV
        
        # Verify NDK installation
        if [ -f "${ANDROID_NDK_HOME}/build/cmake/android.toolchain.cmake" ]; then
          echo "✅ Android NDK toolchain found"
        else
          echo "❌ Android NDK toolchain not found"
          exit 1
        fi
        
        # Clean up
        rm ${NDK_ZIP}
      working-directory: ${{ runner.temp }}
      shell: bash

    - name: Install Fuchsia SDK
      if: startsWith(matrix.platform, 'fuchsia')
      run: |
        echo "Fuchsia SDK installation skipped - requires manual setup"
        # Note: Fuchsia SDK requires authentication, will need to be set up separately
        mkdir -p ${{ runner.temp }}/fuchsia-sdk
        echo "FUCHSIA_SDK=${{ runner.temp }}/fuchsia-sdk" >> $GITHUB_ENV
      shell: bash

    - name: Install iOS toolchain
      if: startsWith(matrix.platform, 'ios')
      run: |
        brew install ios-deploy
        echo "SDKROOT=$(xcrun --sdk iphoneos --show-sdk-path)" >> $GITHUB_ENV
        echo "CMAKE_OSX_SYSROOT=$(xcrun --sdk iphoneos --show-sdk-path)" >> $GITHUB_ENV
      shell: bash

    - name: Install cross-compilation tools (Linux)
      if: matrix.runner == 'ubuntu-latest' && !startsWith(matrix.platform, 'android') && !startsWith(matrix.platform, 'fuchsia')
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          gcc-arm-linux-gnueabihf \
          g++-arm-linux-gnueabihf \
          gcc-aarch64-linux-gnu \
          g++-aarch64-linux-gnu \
          gcc-i686-linux-gnu \
          g++-i686-linux-gnu \
          gcc-riscv64-linux-gnu \
          g++-riscv64-linux-gnu \
          gcc-riscv32-linux-gnu \
          g++-riscv32-linux-gnu \
          binutils-multiarch \
          qemu-user-static \
          make
      shell: bash

    - name: Configure CMake (Android)
      if: startsWith(matrix.platform, 'android')
      working-directory: quickjs
      shell: bash
      run: |
        mkdir -p build
        cd build
        
        ANDROID_TOOLCHAIN="${ANDROID_NDK_HOME}/build/cmake/android.toolchain.cmake"
        
        if [ ! -f "${ANDROID_TOOLCHAIN}" ]; then
          echo "❌ Android toolchain not found at ${ANDROID_TOOLCHAIN}"
          exit 1
        fi
        
        echo "Using Android NDK: ${ANDROID_NDK_HOME}"
        echo "Using Android ABI: ${{ matrix.ndk_abi }}"
        
        cmake .. \
          -DCMAKE_TOOLCHAIN_FILE="${ANDROID_TOOLCHAIN}" \
          -DANDROID_ABI="${{ matrix.ndk_abi }}" \
          -DANDROID_PLATFORM=android-21 \
          -DANDROID_STL=c++_shared \
          -DBUILD_SHARED_LIBS=ON \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}

    - name: Configure CMake (Linux cross-compile)
      if: matrix.platform == 'linux' && matrix.arch != 'x64'
      working-directory: quickjs
      shell: bash
      run: |
        mkdir -p build
        cd build
        
        cmake .. \
          -DCMAKE_SYSTEM_NAME=Linux \
          -DCMAKE_C_COMPILER=${{ matrix.target }}-gcc \
          -DCMAKE_CXX_COMPILER=${{ matrix.target }}-g++ \
          -DBUILD_SHARED_LIBS=ON \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}

    - name: Configure CMake (Linux native)
      if: matrix.platform == 'linux' && matrix.arch == 'x64'
      working-directory: quickjs
      shell: bash
      run: |
        mkdir -p build
        cd build
        
        cmake .. \
          -DBUILD_SHARED_LIBS=ON \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}

    - name: Configure CMake (macOS)
      if: matrix.platform == 'macos'
      working-directory: quickjs
      shell: bash
      run: |
        mkdir -p build
        cd build
        
        if [ "${{ matrix.arch }}" = "arm64" ]; then
          ARCH_FLAG="-DCMAKE_OSX_ARCHITECTURES=arm64"
        else
          ARCH_FLAG="-DCMAKE_OSX_ARCHITECTURES=x86_64"
        fi
        
        cmake .. \
          ${ARCH_FLAG} \
          -DBUILD_SHARED_LIBS=ON \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}

    - name: Configure CMake (iOS)
      if: startsWith(matrix.platform, 'ios')
      working-directory: quickjs
      shell: bash
      run: |
        mkdir -p build
        cd build
        
        cmake .. \
          -DCMAKE_SYSTEM_NAME=iOS \
          -DCMAKE_OSX_DEPLOYMENT_TARGET=11.0 \
          -DCMAKE_OSX_ARCHITECTURES=arm64 \
          -DBUILD_SHARED_LIBS=ON \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}

    - name: Configure CMake (Fuchsia)
      if: startsWith(matrix.platform, 'fuchsia')
      working-directory: quickjs
      shell: bash
      run: |
        mkdir -p build
        cd build
        
        echo "⚠️ Fuchsia build requires manual SDK setup - skipping configuration"
        exit 1

    - name: Configure CMake (Windows)
      if: matrix.runner == 'windows-latest'
      working-directory: quickjs
      shell: pwsh
      run: |
        New-Item -ItemType Directory -Force -Path build
        cd build
        
        cmake .. `
          -G "${{ matrix.generator }}" `
          -A "${{ matrix.arch_flag }}" `
          -DBUILD_SHARED_LIBS=ON `
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}

    - name: Build
      if: success() && !startsWith(matrix.platform, 'fuchsia')
      working-directory: quickjs/build
      shell: bash
      run: |
        if [ "${{ matrix.runner }}" = "windows-latest" ]; then
          # Windows build
          cmake --build . --config ${{ env.BUILD_TYPE }} -j ${NUMBER_OF_PROCESSORS}
        else
          # Unix-like build
          if command -v nproc &> /dev/null; then
            JOBS=$(nproc)
          elif command -v sysctl &> /dev/null; then
            JOBS=$(sysctl -n hw.ncpu)
          else
            JOBS=4
          fi
          cmake --build . --config ${{ env.BUILD_TYPE }} -j ${JOBS}
        fi
      shell: bash

    - name: Determine library extension
      id: ext
      shell: bash
      run: |
        if [ "${{ matrix.platform }}" = "windows" ]; then
          echo "EXT=dll" >> $GITHUB_OUTPUT
        elif [ "${{ matrix.platform }}" = "macos" ] || [ "${{ matrix.platform }}" = "ios" ]; then
          echo "EXT=dylib" >> $GITHUB_OUTPUT
        else
          echo "EXT=so" >> $GITHUB_OUTPUT
        fi

    - name: Prepare artifacts
      if: success()
      shell: bash
      run: |
        mkdir -p artifacts
        LIB_NAME="libqjs-${{ matrix.platform }}-${{ matrix.arch }}.${{ steps.ext.outputs.EXT }}"
        
        # Find and copy the built library
        if [ "${{ matrix.platform }}" = "windows" ]; then
          # Windows: find .dll files
          find quickjs/build -name "*.dll" -type f -exec cp {} "artifacts/$LIB_NAME" \;
        elif [ "${{ matrix.platform }}" = "macos" ] || [ "${{ matrix.platform }}" = "ios" ]; then
          # macOS/iOS: find .dylib files
          find quickjs/build -name "*.dylib" -type f -exec cp {} "artifacts/$LIB_NAME" \;
        else
          # Linux/Android: find .so files
          find quickjs/build -name "*.so" -type f -exec cp {} "artifacts/$LIB_NAME" \;
        fi
        
        # Verify library was found
        if [ -f "artifacts/$LIB_NAME" ]; then
          echo "✅ Library created: $LIB_NAME"
          file "artifacts/$LIB_NAME"
        else
          echo "❌ Library not found: $LIB_NAME"
          echo "Searching for libraries in build directory:"
          find quickjs/build -name "*.so" -o -name "*.dylib" -o -name "*.dll" | head -10
          exit 1
        fi
        
        # Create archive
        cd artifacts
        if [ "${{ matrix.platform }}" = "windows" ]; then
          zip -r "../libqjs-${{ matrix.platform }}-${{ matrix.arch }}-${{ env.VERSION }}.zip" "$LIB_NAME"
        else
          tar -czf "../libqjs-${{ matrix.platform }}-${{ matrix.arch }}-${{ env.VERSION }}.tar.gz" "$LIB_NAME"
        fi
        cd ..

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: libqjs-${{ matrix.platform }}-${{ matrix.arch }}-${{ env.VERSION }}
        path: |
          artifacts/*
          libqjs-*.tar.gz
          libqjs-*.zip
        retention-days: 7

  create-release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/libqjs-')
    permissions:
      contents: write
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        merge-multiple: true

    - name: Prepare release assets
      run: |
        mkdir -p release_assets
        find artifacts -type f -name "*.so" -o -name "*.dylib" -o -name "*.dll" -o -name "*.tar.gz" -o -name "*.zip" | while read file; do
          cp "$file" release_assets/
        done
        ls -la release_assets/

    - name: Extract version
      id: version
      run: echo "version=${GITHUB_REF_NAME#libqjs-}" >> $GITHUB_OUTPUT

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: QuickJS ${{ steps.version.outputs.version }}
        tag_name: ${{ github.ref_name }}
        draft: false
        prerelease: false
        generate_release_notes: true
        files: |
          release_assets/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
