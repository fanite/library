name: Build QuickJS Shared Libraries

on:
  push:
    tags:
      - 'libqjs-*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag'
        required: true
        default: 'v0.12.1'

env:
  BUILD_TYPE: Release
  QJS_REPO: https://github.com/quickjs-ng/quickjs.git

jobs:

# ==========================================================
# Linux (Full Cross Matrix incl. riscv)
# ==========================================================
  linux:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        arch: [x64, arm, arm64, ia32, riscv32, riscv64]

    steps:
      - uses: actions/checkout@v4

      - name: Install cross toolchains
        run: |
          sudo apt update
          sudo apt install -y \
            gcc g++ \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
            gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf \
            gcc-i686-linux-gnu g++-i686-linux-gnu \
            gcc-riscv64-linux-gnu g++-riscv64-linux-gnu

      - name: Clone quickjs
        run: git clone --depth=1 -b ${{inputs.version}} $QJS_REPO quickjs

      - name: Configure Toolchain
        run: |
          case "${{ matrix.arch }}" in
            x64)
              CC=gcc
              ;;
            ia32)
              CC=i686-linux-gnu-gcc
              ;;
            arm)
              CC=arm-linux-gnueabihf-gcc
              ;;
            arm64)
              CC=aarch64-linux-gnu-gcc
              ;;
            riscv64)
              CC=riscv64-linux-gnu-gcc
              ;;
            riscv32)
              sudo apt install -y gcc-riscv64-unknown-elf
              CC=riscv64-unknown-elf-gcc
              ;;
          esac

          mkdir build && cd build
          cmake ../quickjs \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=ON \
            -DCMAKE_C_COMPILER=$CC

      - name: Build
        run: cmake --build build --target qjs --config Release

      - name: Package
        run: |
          mkdir dist
          cp build/*qjs*.so \
            dist/libqjs-linux-${{ matrix.arch }}.so

      - name: SHA256
        run: |
          cd dist
          sha256sum * > SHA256SUMS.txt

      - uses: softprops/action-gh-release@v2
        with:
          files: dist/*



# ==========================================================
# Windows
# ==========================================================
  windows:
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x64, ia32]

    steps:
      - uses: actions/checkout@v4
      - run: git clone --depth=1 -b ${{inputs.version}} $QJS_REPO quickjs

      - name: Configure
        run: |
          cmake -S quickjs -B build `
            -DBUILD_SHARED_LIBS=ON `
            -A ${{ matrix.arch == 'x64' && 'x64' || 'Win32' }}

      - name: Build
        run: cmake --build build --target qjs --config Release

      - name: Package
        run: |
          mkdir dist
          copy build\Release\*.dll `
            dist\libqjs-windows-${{ matrix.arch }}.dll

      - uses: softprops/action-gh-release@v2
        with:
          files: dist/*



# ==========================================================
# macOS Universal
# ==========================================================
  macos:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4
      - run: git clone --depth=1 -b ${{inputs.version}} $QJS_REPO quickjs

      - run: |
          cmake -S quickjs -B build-x64 \
            -DBUILD_SHARED_LIBS=ON \
            -DCMAKE_OSX_ARCHITECTURES=x86_64
          cmake --build build-x64 --config Release

      - run: |
          cmake -S quickjs -B build-arm64 \
            -DBUILD_SHARED_LIBS=ON \
            -DCMAKE_OSX_ARCHITECTURES=arm64
          cmake --build build-arm64 --target qjs --config Release

      - run: |
          mkdir dist
          lipo -create \
            build-x64/*.dylib \
            build-arm64/*.dylib \
            -output dist/libqjs-macos-universal.dylib

      - run: shasum -a 256 dist/* > dist/SHA256SUMS.txt

      - uses: softprops/action-gh-release@v2
        with:
          files: dist/*



# ==========================================================
# Android
# ==========================================================
  android:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        abi: [armeabi-v7a, arm64-v8a, x86, x86_64]

    steps:
      - uses: actions/checkout@v4
      - uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26d

      - run: git clone --depth=1 -b ${{inputs.version}} $QJS_REPO quickjs

      - run: |
          cmake -S quickjs -B build \
            -DCMAKE_TOOLCHAIN_FILE=$ANDROID_NDK/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=${{ matrix.abi }} \
            -DANDROID_PLATFORM=android-21 \
            -DBUILD_SHARED_LIBS=ON

          cmake --build build --target qjs --config Release

      - run: |
          mkdir dist
          cp build/*.so \
            dist/libqjs-android-${{ matrix.abi }}.so
          sha256sum dist/* > dist/SHA256SUMS.txt

      - uses: softprops/action-gh-release@v2
        with:
          files: dist/*



# ==========================================================
# iOS Universal
# ==========================================================
  ios:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4
      - run: git clone --depth=1 -b ${{inputs.version}} $QJS_REPO quickjs

      - run: |
          cmake -S quickjs -B build-device \
            -DCMAKE_SYSTEM_NAME=iOS \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DBUILD_SHARED_LIBS=ON
          cmake --build build-device --target qjs --config Release

      - run: |
          cmake -S quickjs -B build-sim \
            -DCMAKE_SYSTEM_NAME=iOS \
            -DCMAKE_OSX_ARCHITECTURES=x86_64 \
            -DCMAKE_OSX_SYSROOT=iphonesimulator \
            -DBUILD_SHARED_LIBS=ON
          cmake --build build-sim --target qjs --config Release

      - run: |
          mkdir dist
          lipo -create \
            build-device/*.dylib \
            build-sim/*.dylib \
            -output dist/libqjs-ios-universal.dylib

      - run: shasum -a 256 dist/* > dist/SHA256SUMS.txt

      - uses: softprops/action-gh-release@v2
        with:
          files: dist/*



# ==========================================================
# Fuchsia
# ==========================================================
  fuchsia:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [x64, arm64]

    steps:
      - uses: actions/checkout@v4

      - name: Install Fuchsia SDK
        run: |
          curl -LO https://storage.googleapis.com/fuchsia/releases/sdk/linux/latest/sdk.tar.gz
          tar xf sdk.tar.gz
          export FUCHSIA_SDK=$PWD

      - run: git clone --depth=1 -b ${{inputs.version}} $QJS_REPO quickjs

      - run: |
          mkdir build && cd build
          cmake ../quickjs \
            -DCMAKE_SYSTEM_NAME=Fuchsia \
            -DCMAKE_C_COMPILER=$FUCHSIA_SDK/tools/${{ matrix.arch }}-fuchsia-clang \
            -DBUILD_SHARED_LIBS=ON
          cmake --build . --target qjs --config Release

      - run: |
          mkdir dist
          cp build/*.so \
            dist/libqjs-fuchsia-${{ matrix.arch }}.so
          sha256sum dist/* > dist/SHA256SUMS.txt

      - uses: softprops/action-gh-release@v2
        with:
          files: dist/*
